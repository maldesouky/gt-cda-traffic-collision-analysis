USE [chicago-crashes];

PRINT 'STAGE 1: ZIP Code Groups...';
WITH FATALITIES_PCT_CUSUM AS (
	SELECT
		 DISTINCT ZIP_CODE
		,SUM([INJURIES_FATAL_PCT]) AS FAT_PCT_SUM
		,SUM(SUM([INJURIES_FATAL_PCT])) OVER (ORDER BY SUM([INJURIES_FATAL_PCT]) DESC) AS FAT_PCT_CUSUM
	FROM [dbo].[crashes-cleaned]
	--WHERE 
	GROUP BY ZIP_CODE
), ZIP_GROUP_TEMP AS (
	SELECT
		*
		,CASE
			WHEN FAT_PCT_CUSUM > 0.0 AND FAT_PCT_CUSUM <= 0.4 THEN 'A'
			WHEN FAT_PCT_CUSUM > 0.4 AND FAT_PCT_CUSUM <= 0.7 THEN 'B'
			WHEN FAT_PCT_CUSUM > 0.7 AND FAT_PCT_CUSUM <= 0.9 THEN 'C'
			ELSE 'D'
		END AS ZIP_CODE_GROUP
	FROM FATALITIES_PCT_CUSUM
)
UPDATE [dbo].[crashes-cleaned]
SET [crashes-cleaned].ZIP_CODE_GROUP = ZIP_GROUP_TEMP.ZIP_CODE_GROUP
FROM [crashes-cleaned]
LEFT JOIN ZIP_GROUP_TEMP
	ON [crashes-cleaned].ZIP_CODE = ZIP_GROUP_TEMP.ZIP_CODE
--ORDER BY FAT_PCT_CUSUM



PRINT 'STAGE 2: Impute NULL Injuries...';
UPDATE [crashes-cleaned]
SET  MOST_SEVERE_INJURY='NO INDICATION OF INJURY'
    ,INJURIES_TOTAL=0
    ,INJURIES_FATAL=0
    ,INJURIES_INCAPACITATING=0
    ,INJURIES_NON_INCAPACITATING=0
    ,INJURIES_REPORTED_NOT_EVIDENT=0
    ,INJURIES_NO_INDICATION=0
    ,INJURIES_TOTAL_PCT=0
    ,INJURIES_FATAL_PCT=0
    ,INJURIES_INCAPACITATING_PCT=0
WHERE INJURIES_TOTAL IS NULL

UPDATE [crashes-cleaned]
SET MOST_SEVERE_INJURY='NO INDICATION OF INJURY'
WHERE MOST_SEVERE_INJURY IS NULL



PRINT 'STAGE 3: Define injury classes...';
WITH INJURY_CLASSES_TEMP AS (
	SELECT
		   DISTINCT MOST_SEVERE_INJURY
		,CASE
			WHEN MOST_SEVERE_INJURY='FATAL' THEN 'A'
			WHEN MOST_SEVERE_INJURY='INCAPACITATING INJURY' THEN 'B'
			WHEN MOST_SEVERE_INJURY='NONINCAPACITATING INJURY' THEN 'C'
			WHEN MOST_SEVERE_INJURY='REPORTED, NOT EVIDENT' THEN 'C'
			ELSE 'D'
		END AS INJURY_CLASS
	FROM [chicago-crashes].[dbo].[crashes-cleaned]
)
UPDATE [dbo].[crashes-cleaned]
SET [crashes-cleaned].INJURY_CLASS = INJURY_CLASSES_TEMP.INJURY_CLASS
FROM [crashes-cleaned]
LEFT JOIN INJURY_CLASSES_TEMP
	ON [crashes-cleaned].MOST_SEVERE_INJURY = INJURY_CLASSES_TEMP.MOST_SEVERE_INJURY



PRINT 'DONE!'
